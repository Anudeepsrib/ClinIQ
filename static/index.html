<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinIQ — Enterprise Healthcare RAG</title>
    <meta name="description" content="Secure, multimodal RAG system for hospital policy and clinical guidelines with department-scoped access.">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

    <!-- ============================================================ -->
    <!-- LOGIN PAGE -->
    <!-- ============================================================ -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="login-logo">
                <div class="brand-mark">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                        <path d="M2 17L12 22L22 17"/>
                        <path d="M2 12L12 17L22 12"/>
                    </svg>
                </div>
                <h1>Clin<span>IQ</span></h1>
                <p>Enterprise Healthcare RAG</p>
            </div>
            <form id="loginForm" autocomplete="off">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" placeholder="admin" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="••••••••" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-primary btn-full" id="loginBtn">Sign In</button>
                <p id="loginError" class="error-text hidden"></p>
            </form>
            <p class="login-hint">Default: <code>admin</code> / <code>admin123</code></p>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- MAIN APP -->
    <!-- ============================================================ -->
    <div id="mainApp" class="hidden">

        <!-- ── SIDEBAR ── -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <!-- Brand -->
                <div class="brand">
                    <div class="brand-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                            <path d="M2 17L12 22L22 17"/>
                            <path d="M2 12L12 17L22 12"/>
                        </svg>
                    </div>
                    <span class="brand-name">Clin<em>IQ</em></span>
                </div>
                <!-- New Chat -->
                <button class="btn-new-chat" onclick="clearChat()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    New Chat
                </button>
            </div>

            <!-- Department Filter -->
            <div class="sidebar-section">
                <div class="sidebar-label">Search In</div>
                <div class="dept-chips" id="deptFilter"></div>
            </div>

            <!-- Chat History -->
            <div class="chat-history-list" id="chatHistoryList">
                <!-- populated by JS -->
            </div>

            <!-- Footer: User info -->
            <div class="sidebar-footer">
                <div class="user-pill">
                    <div class="user-avatar" id="userAvatarLetter">A</div>
                    <div class="user-meta">
                        <div class="user-name" id="navUser">admin</div>
                        <span id="navRole" class="role-badge role-admin">Admin</span>
                    </div>
                </div>
                <button class="btn-icon" id="adminToggleBtn" onclick="toggleAdminPanel()" title="Admin Panel" style="display:none">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
                <button class="btn-icon" onclick="logout()" title="Sign Out">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                </button>
            </div>
        </aside>

        <!-- ── MAIN AREA ── -->
        <div class="main-area">

            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <div class="model-pill">
                        <span class="dot"></span>
                        GPT-4o · RAG
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="btn-ghost" onclick="toggleKbPanel()">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Knowledge Base
                    </button>
                </div>
            </header>

            <!-- Admin Panel -->
            <div id="adminPanel" class="admin-panel hidden">
                <div class="admin-inner">
                    <div class="admin-grid">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                Create User
                            </div>
                            <div class="admin-card-body">
                                <div class="form-row">
                                    <input type="text" id="newUsername" placeholder="Username" class="input-sm">
                                    <input type="text" id="newFullName" placeholder="Full Name" class="input-sm">
                                </div>
                                <div class="form-row">
                                    <input type="password" id="newPassword" placeholder="Password" class="input-sm">
                                    <select id="newRole" class="input-sm">
                                        <option value="viewer">Viewer</option>
                                        <option value="researcher">Researcher</option>
                                        <option value="technician">Technician</option>
                                        <option value="nurse">Nurse</option>
                                        <option value="doctor">Doctor</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <div id="deptCheckboxes" class="dept-checkboxes"></div>
                                </div>
                                <button class="btn-primary btn-sm" onclick="createUser()">Create User</button>
                            </div>
                        </div>
                        <div class="admin-card">
                            <div class="admin-card-header">
                                Users
                                <button class="btn-ghost btn-sm" onclick="loadUsers()">Refresh</button>
                            </div>
                            <div class="admin-card-body" id="userList">
                                <p style="color:var(--text-muted);font-size:0.8rem;">Loading...</p>
                            </div>
                        </div>
                        <div class="admin-card">
                            <div class="admin-card-header">Department Stats</div>
                            <div class="admin-card-body" id="deptStats">
                                <p style="color:var(--text-muted);font-size:0.8rem;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chatArea">
                <!-- Empty state -->
                <div class="chat-empty" id="chatEmpty">
                    <div style="width:56px;height:56px;background:linear-gradient(135deg,var(--primary),var(--emerald));border-radius:16px;display:flex;align-items:center;justify-content:center;margin-bottom:1.25rem;box-shadow:0 4px 16px var(--primary-glow);">
                        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                            <path d="M2 17L12 22L22 17"/>
                            <path d="M2 12L12 17L22 12"/>
                        </svg>
                    </div>
                    <h2>How can I help you today?</h2>
                    <p>Ask me anything about your department's clinical guidelines, hospital policies, coverage tables, or prior authorization requirements.</p>
                    <div class="suggestion-grid">
                        <button class="suggestion-card" onclick="usesuggestion(this)">What are the prior auth requirements for MRI scans?</button>
                        <button class="suggestion-card" onclick="usesuggestion(this)">Summarize the infection control policy for ICU.</button>
                        <button class="suggestion-card" onclick="usesuggestion(this)">What medications require dual sign-off?</button>
                        <button class="suggestion-card" onclick="usesuggestion(this)">Show coverage criteria for cardiac stenting.</button>
                    </div>
                </div>

                <!-- Messages -->
                <div class="chat-messages" id="chatMessages"></div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-inner">
                    <div class="input-box">
                        <textarea id="questionInput" placeholder="Ask about coverage, prior auth, clinical guidelines…" rows="1" onkeydown="handleEnter(event)" oninput="autoResize(this)"></textarea>
                        <button class="send-btn" onclick="sendQuery()" id="sendBtn" title="Send (Enter)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                    <p class="input-hint">ClinIQ uses retrieval-augmented generation. Always verify critical clinical decisions.</p>
                </div>
            </div>
        </div><!-- /main-area -->

        <!-- ── KNOWLEDGE BASE DRAWER ── -->
        <aside class="kb-panel" id="kbPanel">
            <div class="kb-panel-header">
                <span>Knowledge Base</span>
                <div style="display:flex;align-items:center;gap:0.5rem;">
                    <span class="status-indicator" id="dbStatus">
                        <svg width="8" height="8" viewBox="0 0 8 8"><circle cx="4" cy="4" r="4" fill="#10B981"/></svg>
                        Ready
                    </span>
                    <button class="btn-icon" onclick="toggleKbPanel()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
            </div>
            <div class="kb-panel-body">
                <div class="dept-selector">
                    <label>Upload to:</label>
                    <select id="uploadDept" class="dept-select"></select>
                </div>
                <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                    </div>
                    <p>Drag & drop policies, coverage tables, or medical images</p>
                    <p class="file-types">PDF, DOCX, XLSX, PNG, JPG, TIFF, DICOM</p>
                    <input type="file" id="fileInput" hidden accept=".pdf,.docx,.xlsx,.xls,.png,.jpg,.jpeg,.tiff,.bmp,.dcm">
                    <button class="btn-secondary" onclick="event.stopPropagation();document.getElementById('fileInput').click()">Select File</button>
                </div>
                <div id="imagePreview" class="image-preview hidden">
                    <img id="previewImg" src="" alt="Preview">
                    <span id="previewName"></span>
                </div>
                <div id="uploadList" class="file-list"></div>
            </div>
        </aside>

    </div><!-- /mainApp -->

    <div id="notification" class="notification hidden"></div>
    <script src="/static/js/script.js"></script>
</body>
</html>
